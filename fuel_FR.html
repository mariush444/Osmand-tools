<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FR Fuel GPX Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 700px; margin: 0 auto; padding: 20px; background-color: #f4f4f4; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; font-size: 1.5em; }

        .form-group { margin-bottom: 15px; display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: bold; }
        select, input[type="checkbox"] { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        button { background-color: #007bff; color: white; border: none; padding: 12px 20px; font-size: 16px; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #status { margin-top: 20px; padding: 10px; border-radius: 4px; text-align: center; font-weight: bold; }

        /* Legend Styles */
        #legend-container {
            margin-top: 20px;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            background-color: #fff;
            display: none; /* Hidden by default until data loads */
        }
        .legend-title { font-weight: bold; margin-bottom: 10px; text-decoration: underline; }
        .legend-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 4px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .range-text { font-weight: bold; }

        /* Status colors */
        .status-ok { background-color: #d4edda; color: #155724; }
        .status-err { background-color: #f8d7da; color: #721c24; }
        .status-process { background-color: #fff3cd; color: #856404; }
    </style>
</head>
<body>

<div class="container">
<div class="container">
<div id=logo>
<a href="https://mariush444.github.io/Osmand-tools/">
<img src="https://avatars.githubusercontent.com/u/66887280?v=4&size=64" alt="Main Page" style="width:30px;height:30px;">
</a>
</div>
    <h1>üá®üáµ Colored Fuel Prices to GPX</h1>

    <div class="form-group">
        <label for="fuelType">Select Fuel Type:</label>
        <select id="fuelType">
            <option value="1">Gazole</option>
            <option value="5">E10</option>
            <option value="2">SP95</option>
            <option value="6">SP98</option>
            <option value="3">E85</option>
            <option value="4">GPLc</option>
        </select>
    </div>

    <div class="form-group">
        <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="doBlack" style="width: 20px; height: 20px; margin-right: 10px;">
            Include stations without this fuel
        </label>
    </div>

    <button id="generateBtn" onclick="processData()">Download and Generate GPX</button>

    <div id="status"></div>

    <!-- Legend Section -->
    <div id="legend-container">
        <div class="legend-title">Ordered due to prices means:</div>
        <div id="legend-rows"></div>
        <div style="margin-top: 10px; font-size: 0.85em; color: #555;">
            Stations without selected fuel are not included in a file. If option 'Include stations without this fuel' is checked on then the stations will be included in a file
            and marked as 'Black'. The stations will be stored in group 'Absence' so they can be excluded from view in Osmand.
        </div>
    </div>
</div>

<script>
const TARGET_URL = "https://donnees.roulez-eco.fr/opendata/instantane";
<!-- old proxy const URL = "https://corsproxy.io/?" + encodeURIComponent(TARGET_URL); 
const URL = "https://api.allorigins.win/raw?url=" + encodeURIComponent(TARGET_URL); -->
const URL = "https://api.codetabs.com/v1/proxy?quest=" + encodeURIComponent(TARGET_URL);
    
const fuelTAB = {
    1: "Gazole",
    2: "SP95",
    3: "E85",
    4: "GPLc",
    5: "E10",
    6: "SP98"
};

const serviceEmojis = {
    "Bar": "üç¥",
    "Restauration sur place": "üç¥",
    "Boutique alimentaire": "üõí",
    "DAB (Distributeur automatique de billets)": "üèß",
    "Douches": "üöø",
    "Espace b√©b√©": "üöº",
    "Relais colis": "üéÅ",
    "Services r√©paration / entretien": "üõ†Ô∏è",
    "Station de gonflage": "ñ•ï",
    "Toilettes publiques": "üöª",
    "Wifi": "·Ø§"
};

function setStatus(msg, type) {
    const el = document.getElementById('status');
    <!-- el.innerText = msg; -->
    el.innerHTML = msg;
    el.className = 'status-' + type;
}

function createLegend(Pmin, P0_5, P5_10, P11_20, P21_30, P31_40, P41_80, P81_90, Pmax, fuelName) {
    const container = document.getElementById('legend-container');
    const rows = document.getElementById('legend-rows');
    rows.innerHTML = ""; // Clear previous

    // Helper to make a row
    const addRow = (low, high, color, textColor, label) => {
        const div = document.createElement('div');
        div.className = 'legend-row';
        div.style.backgroundColor = color;
        div.style.color = textColor;
        div.innerHTML = `<span class="range-text">${low}‚Ç¨ - ${high}‚Ç¨</span> <span>${label}</span>`;
        rows.appendChild(div);
    };

    const to3 = (n) => n.toFixed(3);
    const next = (n) => (n + 0.001).toFixed(3);

    addRow(to3(Pmin), to3(P0_5), "#10c0f0", "black", "Light Blue");
    addRow(next(P0_5), to3(P5_10), "#00842b", "white", "Dark Green");
    addRow(next(P5_10), to3(P11_20), "#88e030", "black", "Bright Green");
    addRow(next(P11_20), to3(P21_30), "#eecc22", "black", "Yellow");
    addRow(next(P21_30), to3(P31_40), "#ff8500", "white", "Orange");
    addRow(next(P31_40), to3(P41_80), "#d00d0d", "white", "Red");
    addRow(next(P41_80), to3(P81_90), "#a71de1", "white", "Violet");
    addRow(next(P81_90), to3(Pmax), "#1010a0", "white", "Navy Blue");
    // 9. Black
    const blackDiv = document.createElement('div');
    blackDiv.className = 'legend-row';
    blackDiv.style.backgroundColor = "black";
    blackDiv.style.color = "white";
    blackDiv.innerHTML = `<span class="range-text">Absence</span> <span>Black (no ${fuelName})</span>`;
    rows.appendChild(blackDiv);

    container.style.display = "block";
}
const PROXY_LIST = [
    "https://api.allorigins.win/raw?url=",
    "https://api.codetabs.com/v1/proxy?quest="
    "https://corsproxy.io/?"
];
    
async function processData() {
    const btn = document.getElementById('generateBtn');
    const fuel = document.getElementById('fuelType').value;
    const DOblack = document.getElementById('doBlack').checked;
    const legendContainer = document.getElementById('legend-container');

    btn.disabled = true;
    legendContainer.style.display = "none"; // Hide legend while processing
    <!-- setStatus("Downloading data via proxy...", "process");

    try {
        // 1. Download
        const response = await fetch(URL);
        if (!response.ok) throw new Error("HTTP Error " + response.status);

        setStatus("Unzipping file...", "process");

        // 2. Unzip
        const zipData = await response.blob();
        const zip = await JSZip.loadAsync(zipData);

        // Find the XML file (Handle folders properly)
        let xmlFile = null;
        zip.forEach((relativePath, zipEntry) => {
            if (relativePath.includes("PrixCarburants_instantane.xml")) {
                xmlFile = zipEntry;
            }
        });
    -->
        setStatus("Connecting...", "process");

        let zip = null;
        let error = null;
    
        // Loop through proxies until one works
        for (let i = 0; i < PROXY_LIST.length; i++) {
            const currentProxy = PROXY_LIST[i];
            const currentUrl = currentProxy + encodeURIComponent(TARGET_URL);
    
            try {
                setStatus(`Downloading data (Attempt ${i + 1}/${PROXY_LIST.length})...`, "process");
                
                const response = await fetch(currentUrl);
                if (!response.ok) throw new Error("HTTP " + response.status);
    
                const zipData = await response.blob();
                zip = await JSZip.loadAsync(zipData);
                
                // If we got here, download was successful! Break the loop.
                break; 
    
            } catch (e) {
                console.warn(`Proxy ${i + 1} failed:`, e);
                error = e;
                // If this is the last proxy and we failed, we will throw the error later
                if (i === PROXY_LIST.length - 1) {
                     throw new Error("All download attempts failed. " + error.message);
                }
            }
        }
    
        if (!zip) throw new Error("Could not download or unzip the file.");
    
        setStatus("Unzipping file...", "process");
    
        // Find the XML file
        let xmlFile = null;
        zip.forEach((relativePath, zipEntry) => {
            if (relativePath.includes("PrixCarburants_instantane.xml")) {
                xmlFile = zipEntry;
            }
        });
    
        if (!xmlFile) throw new Error("Could not find 'PrixCarburants_instantane.xml' inside the ZIP file.");

        // 3. FIX: Decode as ISO-8859-1 (Latin-1) to preserve French characters
        const binaryContent = await xmlFile.async("uint8array");
        const decoder = new TextDecoder("iso-8859-1");
        const xmlContent = decoder.decode(binaryContent);

        setStatus("Parsing XML...", "process");

        // 4. Parse XML
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlContent, "text/xml");
        const stations = xmlDoc.getElementsByTagName("pdv");

        // Debugging: Check if we found stations
        if (stations.length === 0) {
            console.error("No stations found. XML content preview:", xmlContent.substring(0, 500));
            throw new Error("XML Parsing Error: Found 0 stations. Check console for details.");
        }
        console.log("Found " + stations.length + " stations.");

        // 5. Calculate Min/Max (First Pass)
        let Pmin = 1000;
        let Pmax = 0;
        let date = "";
        const selectedFuelId = fuel;

        for (let i = 0; i < stations.length; i++) {
            const prices = stations[i].getElementsByTagName("prix");
            for (let j = 0; j < prices.length; j++) {
                const p = prices[j];
                if (p.getAttribute("id") === selectedFuelId) {
                    const val = parseFloat(p.getAttribute("valeur"));
                    const maj = p.getAttribute("maj");

                    if (!isNaN(val)) {
                        if (Pmin > val) Pmin = val;
                        if (Pmax < val) Pmax = val;
                    }
                    const dateStr = maj.substring(0, 10);
                    if (date < dateStr) date = dateStr;
                }
            }
        }

        if (Pmax === 0 && Pmin === 1000) {
            throw new Error("No prices found for selected fuel type. (Stations found, but no prices matched ID " + selectedFuelId + ")");
        }

        const Prange = Math.round((Pmax - Pmin) * 1000) / 1000;

        // Calculate thresholds
        const thresholds = {
            t0_5: Math.round((Pmin + Prange * 0.05) * 1000) / 1000,
            t5_10: Math.round((Pmin + Prange * 0.10) * 1000) / 1000,
            t11_20: Math.round((Pmin + Prange * 0.20) * 1000) / 1000,
            t21_30: Math.round((Pmin + Prange * 0.30) * 1000) / 1000,
            t31_40: Math.round((Pmin + Prange * 0.40) * 1000) / 1000,
            t41_80: Math.round((Pmin + Prange * 0.80) * 1000) / 1000,
            t81_90: Math.round((Pmin + Prange * 0.90) * 1000) / 1000
        };

        // Generate Legend HTML
        createLegend(Pmin, thresholds.t0_5, thresholds.t5_10, thresholds.t11_20, thresholds.t21_30, thresholds.t31_40, thresholds.t41_80, thresholds.t81_90, Pmax, fuelTAB[selectedFuelId]);

        // Generate GPX
        setStatus("Generating GPX...", "process");
        let gpxContent = `<?xml version='1.0' encoding='UTF-8' standalone='yes' ?>\n`;
        gpxContent += `<gpx version="1.1" creator="OsmAnd+Maryush444" xmlns="http://www.topografix.com/GPX/1/1" xmlns:osmand="https://osmand.net" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">\n`;
        gpxContent += `<metadata><name>fuel FR</name></metadata>\n`;

        for (let i = 0; i < stations.length; i++) {
            const station = stations[i];
            const latRaw = parseFloat(station.getAttribute("latitude"));
            const lonRaw = parseFloat(station.getAttribute("longitude"));

            const latVal = Math.round(latRaw) / 100000;
            const lonVal = Math.round(lonRaw) / 100000;
            const lat = parseFloat(latVal.toFixed(5)).toString();
            const lon = parseFloat(lonVal.toFixed(5)).toString();

            let name = "no " + fuelTAB[selectedFuelId] + " ";
            let desc = "";
            let thePrice = 0;
            let color = "000001"; // black

            const prices = station.getElementsByTagName("prix");
            for (let j = 0; j < prices.length; j++) {
                const p = prices[j];
                const pId = p.getAttribute("id");
                const pVal = p.getAttribute("valeur");
                const pNom = p.getAttribute("nom");
                const pMaj = p.getAttribute("maj");

                desc += "\t" + pNom + " " + pVal + "‚Ç¨ " + pMaj.substring(2, 10) + "&lt;br&gt;\n";

                if (pId === selectedFuelId) {
                    name = pNom + " " + pVal + " " + pMaj.substring(2, 10) + " ";
                    thePrice = parseFloat(pVal);
                }
            }

            // Emojis
            const services = station.getElementsByTagName("service");
            for (let k = 0; k < services.length; k++) {
                const sText = services[k].textContent.trim();
                if (serviceEmojis[sText]) {
                    name += serviceEmojis[sText];
                }
            }

            // Color Logic
            if (thePrice > 0 && thePrice <= thresholds.t0_5) color = "10c0f0"; // light blue
            else if (thePrice > thresholds.t0_5 && thePrice <= thresholds.t5_10) color = "00842b"; // dark green
            else if (thePrice > thresholds.t5_10 && thePrice <= thresholds.t11_20) color = "88e030"; // light green
            else if (thePrice > thresholds.t11_20 && thePrice <= thresholds.t21_30) color = "eecc22"; // yellow
            else if (thePrice > thresholds.t21_30 && thePrice <= thresholds.t31_40) color = "ff8500"; // orange
            else if (thePrice > thresholds.t31_40 && thePrice <= thresholds.t41_80) color = "d00d0d"; // red
            else if (thePrice > thresholds.t41_80 && thePrice <= thresholds.t81_90) color = "a71de1"; // violet
            else if (thePrice > thresholds.t81_90) color = "1010a0"; // blue navy

            // Filter
            if (DOblack === true || color !== "000001") {
                gpxContent += ` <wpt lat="${lat}" lon="${lon}">\n`;
                gpxContent += `\t<name>${name.trim()}</name>\n`;
                gpxContent += `\t<desc>\n${desc}\t</desc>\n`;
                if (color === "000001") gpxContent += `\t<type>Absence</type>\n`;
                gpxContent += `\t<extensions>\n`;
                gpxContent += `\t\t<osmand:color>#${color}</osmand:color>\n`;
                gpxContent += `\t\t<osmand:icon>fuel</osmand:icon>\n`;
                gpxContent += `\t\t<osmand:background>cirlce</osmand:background>\n`;
                gpxContent += `\t</extensions>\n`;
                gpxContent += `</wpt>\n`;
            }
        }

        gpxContent += `</gpx>`;

        // 7. Save File
        const fileName = `üá®üáµ-‚õΩ-${fuelTAB[selectedFuelId]}-${DOblack ? "full" : "only"}-${date.replace(/-/g, '').substring(2)}.gpx`;
        downloadFile(fileName, gpxContent);

        setStatus("Done! GPX Downloaded.", "ok");
        btn.disabled = false;

    } catch (e) {
        console.error(e);
        setStatus("<strong>Error:</strong> " + e.message + "<br><h6>Download failed. The data file is heavy (15MB) and free public proxies often block it. Please try again.<br>If it doesn't help, the better option is to use python script from main page. Click logo icon", "err");
        btn.disabled = false;
    }
}

function downloadFile(filename, content) {
    const element = document.createElement('a');
    element.setAttribute('href', 'data:application/gpx+xml;charset=utf-8,' + encodeURIComponent(content));
    element.setAttribute('download', filename);
    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
}
</script>

</body>
</html>
